<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MealMaster - Configura√ß√µes</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    main{ padding:28px 40px; color:#4e342e }
    h2{ margin:0 0 18px; font-size:1.9rem; font-weight:800 }
    .grid{ display:grid; gap:20px; grid-template-columns: repeat(auto-fit, minmax(320px,1fr)) }
    .card{ background:#fffde7; border-radius:14px; padding:18px 20px; box-shadow:0 4px 12px rgba(0,0,0,.08) }
    .card h3{ margin:0 0 12px; font-weight:800 }
    .field{ margin:10px 0 }
    .field label{ display:block; font-weight:700; margin-bottom:6px }
    .input, textarea, select{
      width:100%; padding:10px 12px; border-radius:10px;
      border:1.5px solid #ffb74d; background:#fff; color:#4e342e; font-weight:600
    }
    textarea{ min-height:70px }
    .row{ display:flex; gap:10px; align-items:center; flex-wrap:wrap }
    .chips{ font-size:.9rem; opacity:.75 }
    .btn{ border:0; border-radius:26px; padding:10px 16px; font-weight:800; cursor:pointer; background:#ffcc80; color:#4e342e; box-shadow:0 2px 6px rgba(0,0,0,.08) }
    .btn--brand{ background:linear-gradient(90deg,#4caf50,#81c784); color:#fffde7; box-shadow:0 6px 14px rgba(129,199,132,.45) }
    .hint{ opacity:.7; font-size:.9rem }
    table{ width:100%; border-collapse:collapse }
    th, td{ padding:8px; border-bottom:1px dashed #ffcc80; text-align:left }
    th{ font-weight:800 }
    .num{ width:90px; text-align:center }
  </style>
</head>
<body>
<header>
  <h1>MealMaster</h1>
  <a href="perfil.html" class="profile-icon" title="Abrir perfil" aria-label="Abrir perfil">üë§</a>
</header>

<nav class="sidebar" role="navigation" aria-label="Menu principal">
  <a href="index.html" data-route="index.html">Menu Principal</a>
  <a href="receitas.html" data-route="receitas.html">Receitas</a>
  <a href="calendario.html" data-route="calendario.html">Plano Semanal</a>
  <a href="listaCompras.html" data-route="listaCompras.html">Lista de Compras</a>
  <a href="configuracoes.html" data-route="configuracoes.html">Configura√ß√µes</a>
</nav>

<script>
  (function(){
    const here=location.pathname.split('/').pop()||'index.html';
    document.querySelectorAll('.sidebar a').forEach(a=>{
      if(a.getAttribute('data-route')===here){a.classList.add('active');a.setAttribute('aria-current','page');}
    });
  })();
</script>

<main>
  <h2>Configura√ß√µes do Plano</h2>

  <div class="grid">
    <!-- Rota√ß√£o e In√≠cio da Semana -->
    <section class="card">
      <h3>Geral</h3>
      <div class="field">
        <label for="rotation">Rota√ß√£o (n√£o repetir por ‚Ä¶ dias)</label>
        <input id="rotation" class="input num" type="number" min="0" max="60" step="1" placeholder="ex: 14">
      </div>

      <div class="field">
        <label>Primeiro dia da semana</label>
        <div class="row">
          <label><input type="radio" name="weekStart" value="mon"> Segunda</label>
          <label><input type="radio" name="weekStart" value="sun"> Domingo</label>
        </div>
        <div class="hint">Afeta a navega√ß√£o no Calend√°rio e a gera√ß√£o/print da semana vis√≠vel.</div>
      </div>
    </section>

    <!-- Limites semanais -->
    <section class="card">
      <h3>Limites por semana</h3>
      <div class="hint">Define m√≠nimos/m√°ximos por grupo. Os grupos s√£o inferidos por palavras no t√≠tulo/etiquetas (ex.: ‚Äúmassa‚Äù, ‚Äúpeixe‚Äù, ‚Äúcarne‚Äù, ‚Äúsopa‚Äù, ‚Äúsalada‚Äù).</div>
      <table>
        <thead><tr><th>Grupo</th><th>M√≠n.</th><th>M√°x.</th></tr></thead>
        <tbody>
          <tr><td>Massa</td> <td><input id="min_massa" class="input num" type="number" min="0" max="7"></td> <td><input id="max_massa" class="input num" type="number" min="0" max="7"></td></tr>
          <tr><td>Peixe</td> <td><input id="min_peixe" class="input num" type="number" min="0" max="7"></td> <td><input id="max_peixe" class="input num" type="number" min="0" max="7"></td></tr>
          <tr><td>Carne</td> <td><input id="min_carne" class="input num" type="number" min="0" max="7"></td> <td><input id="max_carne" class="input num" type="number" min="0" max="7"></td></tr>
          <tr><td>Sopa</td>  <td><input id="min_sopa"  class="input num" type="number" min="0" max="7"></td> <td><input id="max_sopa"  class="input num" type="number" min="0" max="7"></td></tr>
          <tr><td>Salada</td><td><input id="min_salada"class="input num" type="number" min="0" max="7"></td> <td><input id="max_salada"class="input num" type="number" min="0" max="7"></td></tr>
        </tbody>
      </table>
    </section>

    <!-- Prefer√™ncias por refei√ß√£o (mantidas) -->
    <section class="card">
      <h3>Prefer√™ncias por refei√ß√£o</h3>
      <div class="field">
        <label>Pequeno-almo√ßo ‚Äî favorecer</label>
        <input id="pref_pa" class="input" placeholder="ex: aveia, iogurte, fruta, panqueca">
      </div>
      <div class="field">
        <label>Almo√ßo ‚Äî favorecer</label>
        <input id="pref_alm" class="input" placeholder="ex: salada, massa, arroz">
      </div>
      <div class="field">
        <label>Lanche ‚Äî favorecer</label>
        <input id="pref_lan" class="input" placeholder="ex: tosta, sopa">
      </div>
      <div class="field">
        <label>Jantar ‚Äî favorecer</label>
        <input id="pref_jan" class="input" placeholder="ex: sopa, peixe, salada, grelhado, legumes">
      </div>
      <div class="row">
        <label><input type="checkbox" id="jantar_leve"> Preferir jantares leves</label>
        <span class="chips">(sopa, peixe, saladas, grelhados, legumes)</span>
      </div>
    </section>

    <!-- Dias sem carne -->
    <section class="card">
      <h3>Dias sem carne</h3>
      <div class="row" style="flex-wrap:wrap">
        <label><input type="checkbox" class="dia" value="1"> Segunda</label>
        <label><input type="checkbox" class="dia" value="2"> Ter√ßa</label>
        <label><input type="checkbox" class="dia" value="3"> Quarta</label>
        <label><input type="checkbox" class="dia" value="4"> Quinta</label>
        <label><input type="checkbox" class="dia" value="5"> Sexta</label>
        <label><input type="checkbox" class="dia" value="6"> S√°bado</label>
        <label><input type="checkbox" class="dia" value="0"> Domingo</label>
        <label style="margin-left:12px"><input type="checkbox" id="semcarne_peixe" checked> Permitir peixe</label>
      </div>
    </section>

    <!-- A√ß√µes -->
    <section class="card">
      <h3>A√ß√µes</h3>
      <div class="row">
        <button class="btn btn--brand" id="btnGuardar">Guardar</button>
        <button class="btn" id="btnPadroes">Repor padr√µes</button>
      </div>
      <div class="hint">Estas regras s√£o usadas ao ‚ÄúCompletar card√°pio semanal‚Äù.</div>
    </section>
  </div>
</main>

<script>
  const LS_RULES = 'mealmaster_regrasPlano';

  const $ = sel => document.querySelector(sel);
  const $$ = sel => Array.from(document.querySelectorAll(sel));

  function defaults(){
    return {
      rotationDays: 14,
      weekStart: 'mon', // 'mon' ou 'sun'
      limits: {
        massa:  {min:0, max:2},
        peixe:  {min:1, max:7},
        carne:  {min:0, max:4},
        sopa:   {min:0, max:7},
        salada: {min:0, max:7}
      },
      meals: {
        'pequeno-almoco': { prefer:'aveia, iogurte, fruta, panqueca' },
        'almoco':         { prefer:'salada, massa, arroz' },
        'lanche':         { prefer:'tosta, sopa' },
        'jantar':         { prefer:'sopa, peixe, salada, grelhado, legumes', light:true },
        'ceia':           { prefer:'iogurte, fruta' }
      },
      season: { verao:'salada, grelhado, frio, gaspacho', inverno:'sopa, forno, guisado' },
      meatless: { days:[], allowFish:true }
    };
  }

  function loadRules(){ try{ return JSON.parse(localStorage.getItem(LS_RULES)) || defaults(); }catch{ return defaults(); } }
  function saveRules(r){ localStorage.setItem(LS_RULES, JSON.stringify(r)); }

  function rulesToUI(r){
    $('#rotation').value = r.rotationDays ?? 14;
    $$('input[name="weekStart"]').forEach(rb => rb.checked = (rb.value === (r.weekStart||'mon')));

    // limits
    const setLM = (key, field, val)=>{ const el = $(`#${field}_${key}`); if(el) el.value = (r.limits?.[key]?.[field.replace(/^(min_|max_)/,'')] ?? 0); };
    ['massa','peixe','carne','sopa','salada'].forEach(k=>{
      $(`#min_${k}`).value = r.limits?.[k]?.min ?? 0;
      $(`#max_${k}`).value = r.limits?.[k]?.max ?? 7;
    });

    $('#pref_pa').value  = r.meals['pequeno-almoco'].prefer || '';
    $('#pref_alm').value = r.meals['almoco'].prefer || '';
    $('#pref_lan').value = r.meals['lanche'].prefer || '';
    $('#pref_jan').value = r.meals['jantar'].prefer || '';
    $('#jantar_leve').checked = !!r.meals['jantar'].light;

    $$('.dia').forEach(i=> i.checked = (r.meatless.days||[]).includes(parseInt(i.value,10)));
    $('#semcarne_peixe').checked = !!r.meatless.allowFish;
  }

  function uiToRules(){
    const r = loadRules();
    const weekStart = ($$('input[name="weekStart"]').find(rb=>rb.checked)?.value) || 'mon';
    const limits = {};
    ['massa','peixe','carne','sopa','salada'].forEach(k=>{
      limits[k] = {
        min: Math.max(0, parseInt($(`#min_${k}`).value||'0',10)),
        max: Math.max(0, parseInt($(`#max_${k}`).value||'0',10))
      };
    });

    return {
      rotationDays: Math.max(0, parseInt($('#rotation').value||'14',10)),
      weekStart,
      limits,
      meals: {
        'pequeno-almoco': { prefer: $('#pref_pa').value },
        'almoco':         { prefer: $('#pref_alm').value },
        'lanche':         { prefer: $('#pref_lan').value },
        'jantar':         { prefer: $('#pref_jan').value, light: $('#jantar_leve').checked },
        'ceia':           { prefer: '' }
      },
      season: { verao: $('#tag_verao')?.value || (r.season?.verao||''), inverno: $('#tag_inverno')?.value || (r.season?.inverno||'') },
      meatless: { days: $$('.dia:checked').map(i=>parseInt(i.value,10)), allowFish: $('#semcarne_peixe').checked }
    };
  }

  (function(){ rulesToUI(loadRules()); })();

  $('#btnGuardar').addEventListener('click', ()=>{
    saveRules(uiToRules());
    alert('Regras guardadas!');
  });
  $('#btnPadroes').addEventListener('click', ()=>{
    const r = defaults(); saveRules(r); rulesToUI(r);
  });
</script>

<!-- opcional: repor receitas de exemplo -->
<button id="btn-reseed" class="btn">Repor receitas de exemplo</button>
<script>
  document.getElementById('btn-reseed').addEventListener('click', ()=>{
    if(!confirm('Apagar o teu livro atual e repor exemplos?')) return;
    localStorage.removeItem('mealmaster_receitas'); location.reload();
  });
</script>
</body>
</html>
