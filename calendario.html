<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MealMaster - Calend√°rio</title>
  <link rel="stylesheet" href="style.css" />
  <script src="seed.js"></script>

  <style>
    body { background:#fffde7; color:#4e342e; margin:0 }
    main { padding: 20px 40px; }
    .calendario-header { display:flex; justify-content:center; align-items:center; gap:20px; font-weight:700; font-size:1.3rem; margin-bottom:18px; user-select:none; }
    .calendario-header button { background:#4caf50; border:none; color:#fff; padding:8px 15px; border-radius:8px; cursor:pointer; font-weight:700; font-size:1.05rem; box-shadow:0 3px 6px rgba(0,0,0,.2); }
    .calendario-header button:hover { background:#388e3c; }

    .toolbar { display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end; margin-bottom:16px }
    .btn{border:0;border-radius:28px;padding:10px 16px;font-weight:800;cursor:pointer;background:#ffcc80;color:#4e342e;box-shadow:0 2px 6px rgba(0,0,0,.08)}
    .btn--brand{background:linear-gradient(90deg,#ffb347,#ffcc33); color:#6d4c41; box-shadow:0 6px 14px rgba(255,179,71,.45)}
    .btn--brand:hover{filter:brightness(1.06)}
    .btn--ghost{background:#fffde7;border:1.5px solid #ffb74d}
    .btn--danger{background:#e57373;color:#fff}

    table.calendario { width:100%; border-collapse:collapse; table-layout:fixed; font-size:.95rem; user-select:none; background:#fff }
    table.calendario th, table.calendario td { border:1px solid #d7ccc8; padding:12px 8px; text-align:center; vertical-align:middle; min-width:90px; max-width:130px; }
    table.calendario th { background:#ffcc80; color:#4e342e; position:sticky; top:0 }
    table.calendario tbody tr:nth-child(odd) { background:#fffdf3; }
    .slot { background:#ffecb3; border-radius:8px; padding:6px; cursor:pointer; box-shadow:0 2px 5px rgba(255,179,71,.5); transition:background-color .25s; overflow:hidden; white-space:nowrap; text-overflow:ellipsis; }
    .slot:hover { background:#ffe082; }
    .slot.nao { background:#eee; color:#888; font-style:italic }

    .btn-completar { margin-top:10px; background:linear-gradient(90deg,#ffb347,#ffcc33); border:none; padding:12px 22px; border-radius:30px; font-size:1rem; font-weight:800; color:#6d4c41; cursor:pointer; box-shadow:0 5px 12px rgba(255,179,71,.7); }

    /* Modal */
    .modal-bg { position:fixed; inset:0; background:rgba(0,0,0,.35); display:none; justify-content:center; align-items:center; z-index:999; }
    .modal-bg.active { display:flex; }
    .modal { background:#fffde7; border-radius:16px; padding:20px 22px; box-shadow:0 6px 18px rgba(0,0,0,.3); width:min(440px,92vw); color:#4e342e; font-weight:600; }
    .modal h3 { margin:0 0 10px; font-weight:800; font-size:1.25rem; }
    .modal label { display:block; margin:10px 0 6px; font-weight:700; }
    .modal input[type="text"], .modal select { width:100%; padding:9px 10px; border-radius:10px; border:1.5px solid #ffb74d; font-size:1rem; background:#fffde7; }
    .modal .row { display:flex; gap:8px; justify-content:flex-end; margin-top:14px; flex-wrap:wrap }
    .tag-tipo{font-size:.85rem; opacity:.7}

    /* ===== PRINT ===== */
    @page { size: A4 landscape; margin: 12mm; }
    @media print {
      html, body { background: #fff !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
      header, nav.sidebar, .toolbar, .btn-completar, .calendario-header button, .profile-icon { display: none !important; }
      .calendario-header { display: block !important; text-align: center !important; margin: 0 0 8mm 0 !important; font-size: 14pt !important; font-weight: 800 !important; color: #000 !important; }
      #semanaAtual { display: inline-block !important; }
      main { padding: 0 !important; margin: 0 !important; max-width: none !important; background: #fff !important; }
      table.calendario { width: 100% !important; border-collapse: collapse !important; table-layout: fixed !important; font-size: 11pt !important; background: #fff !important; }
      table.calendario th, table.calendario td { border: 1px solid #333 !important; padding: 6pt 8pt !important; vertical-align: top !important; text-align: left !important; color: #000 !important; background: #fff !important; }
      table.calendario th { font-weight: 700 !important; text-align: center !important; position: static !important; }
      .slot, .slot * { white-space: normal !important; overflow: visible !important; text-overflow: clip !important; background: transparent !important; box-shadow: none !important; color: #000 !important; padding: 0 !important; margin: 0 !important; }
      table.calendario tr { page-break-inside: avoid !important; }
    }
  </style>
</head>
<body>
  <header>
    <h1>MealMaster</h1>
    <a href="perfil.html" class="profile-icon" title="Abrir perfil" aria-label="Abrir perfil">üë§</a>
  </header>

  <nav class="sidebar" role="navigation" aria-label="Menu principal">
    <a href="index.html"     data-route="index.html">Menu Principal</a>
    <a href="receitas.html"      data-route="receitas.html">Receitas</a>
    <a href="calendario.html"    data-route="calendario.html">Plano Semanal</a>
    <a href="listaCompras.html"  data-route="listaCompras.html">Lista de Compras</a>
    <a href="configuracoes.html" data-route="configuracoes.html">Configura√ß√µes</a>
  </nav>

  <script>
    // ativa nav
    (function () {
      const here = location.pathname.split('/').pop() || 'index.html';
      document.querySelectorAll('.sidebar a').forEach(a => {
        if (a.getAttribute('data-route') === here) { a.classList.add('active'); a.setAttribute('aria-current','page'); }
      });
    })();
  </script>

  <main>
    <div class="calendario-header">
      <button id="prevWeek" aria-label="Semana anterior">&lt;</button>
      <div id="semanaAtual"></div>
      <button id="nextWeek" aria-label="Semana seguinte">&gt;</button>
    </div>

    <div class="toolbar">
      <button class="btn btn--ghost" id="btnExportar">Exportar semana (PDF)</button>
      <button class="btn btn--brand" id="btnGerarCompras">Gerar lista de compras</button>
    </div>

    <table class="calendario" aria-label="Calend√°rio semanal">
      <thead>
        <tr id="cal-head-row">
          <!-- preenchido por JS de acordo com weekStart -->
        </tr>
      </thead>
      <tbody id="calendarioCorpo"></tbody>
    </table>

    <button class="btn-completar" id="btnCompletar">Completar card√°pio semanal</button>
  </main>

  <!-- Modal -->
  <div class="modal-bg" id="modalEdit">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <h3 id="modalTitle">Escolher receita <span id="etiqueta-tipo" class="tag-tipo"></span></h3>

      <label for="inputReceita">Pesquisar / escrever manualmente</label>
      <input type="text" id="inputReceita" placeholder="Nome da receita..." list="listaReceitas" />
      <datalist id="listaReceitas"></datalist>

      <div class="row">
        <button class="btn" id="btnNaoCozinhar" type="button">N√£o cozinhar</button>
        <button class="btn btn--ghost" id="btnCancelar" type="button">Cancelar</button>
        <button class="btn btn--brand" id="btnSalvar" type="button">Guardar</button>
      </div>
    </div>
  </div>

  <script>
    // ‚Äî‚Äî‚Äî exemplos fallback
    const receitasExemplo = [
      {id:1,titulo:"Ovos mexidos",tipo:'pequeno-almoco', ingredientes:"- ovos\n- manteiga\n- sal"},
      {id:2,titulo:"Panquecas",tipo:'pequeno-almoco', ingredientes:"- farinha\n- ovo\n- leite"},
      {id:3,titulo:"Salada de quinoa",tipo:'almoco', ingredientes:"- quinoa\n- tomate\n- pepino"},
      {id:4,titulo:"Sopa de legumes",tipo:'jantar', ingredientes:"- legumes variados\n- √°gua\n- sal"},
      {id:5,titulo:"Sandu√≠che natural",tipo:'lanche', ingredientes:"- p√£o\n- fiambre\n- queijo"},
      {id:6,titulo:"Frango grelhado",tipo:'jantar', ingredientes:"- peito de frango\n- sal\n- azeite"},
      {id:7,titulo:"Iogurte com frutas",tipo:'ceia', ingredientes:"- iogurte\n- fruta"},
      {id:8,titulo:"Tosta mista",tipo:'lanche', ingredientes:"- p√£o\n- fiambre\n- queijo"},
      {id:9,titulo:"Sushi vegetariano",tipo:'jantar', ingredientes:"- arroz sushi\n- alga nori\n- vegetais"},
      {id:10,titulo:"Batata doce assada",tipo:'jantar', ingredientes:"- batata doce\n- azeite\n- sal"}
    ];

    // LocalStorage keys
    const LS_RULES = 'mealmaster_regrasPlano';
    const LS_REC   = 'mealmaster_receitas';
    const LS_PLANO = 'mealmaster_planoSemanal';
    const LS_LISTA = 'mealmaster_listaCompras';
    const LS_LOCALE= 'mealmaster_locale';

    // util
    const splitComma = (s) => (s || '').toLowerCase().split(/[;,]/).map(x => x.trim()).filter(Boolean);
    const matchesAny = (txt, words) => {
      const t = (txt || '').toLowerCase();
      return words.some(w => t.includes(w));
    };
    const recipeMatches = (r, words) => matchesAny(r.titulo, words) || matchesAny((r.tags || []).join(' '), words);

    function loadRules(){ try { return JSON.parse(localStorage.getItem(LS_RULES)) || {}; } catch { return {}; } }
    function loadLocale(){ try { return JSON.parse(localStorage.getItem(LS_LOCALE)) || null; } catch { return null; } }

    // Hemisf√©rio & sazonalidade
    function currentHemisphere(){ const loc = loadLocale(); return (loc && loc.hemisphere) || 'N'; }
    function isSummerWinter(date){
      const m = date.getMonth(); // 0=Jan
      let isVerao   = (m>=5 && m<=8);              // Jun‚ÄìSet
      let isInverno = (m===11 || m<=1);            // Dez‚ÄìFev
      if(currentHemisphere()==='S'){ const v=isVerao; isVerao=isInverno; isInverno=v; }
      return {isVerao, isInverno};
    }

    // Refei√ß√µes
    function lerRefeicoesDoPerfil(){
      try {
        const salvo = JSON.parse(localStorage.getItem('refeicoesSelecionadas'));
        if (Array.isArray(salvo) && salvo.length) {
          const map = {'pequeno-almoco':'Pequeno almo√ßo','almoco':'Almo√ßo','lanche':'Lanche','jantar':'Jantar','ceia':'Ceia'};
          return salvo.map(k => map[k]).filter(Boolean);
        }
      } catch(e){}
      return ["Pequeno almo√ßo","Almo√ßo","Lanche","Jantar","Ceia"];
    }
    let refeicoes = lerRefeicoesDoPerfil();

    // helpers receitas/plano/lista
    function lerLivroReceitas(){
      try{
        const raw = localStorage.getItem(LS_REC);
        const arr = raw? JSON.parse(raw) : [];
        if(Array.isArray(arr) && arr.length) return arr;
      }catch(e){}
      return receitasExemplo;
    }
    function lerPlano(){ try{ return JSON.parse(localStorage.getItem(LS_PLANO)) || {}; }catch{ return {}; } }
    function gravarPlano(p){ localStorage.setItem(LS_PLANO, JSON.stringify(p)); }
    function lerLista(){ try{ return JSON.parse(localStorage.getItem(LS_LISTA)) || {}; }catch{ return {}; } }
    function gravarLista(o){ localStorage.setItem(LS_LISTA, JSON.stringify(o)); }

    const tipoKeyFromLabel = (lbl) => ({
      'Pequeno almo√ßo':'pequeno-almoco',
      'Almo√ßo':'almoco',
      'Lanche':'lanche',
      'Jantar':'jantar',
      'Ceia':'ceia'
    }[lbl] || 'almoco');

    let planoSemanal = lerPlano();

    // Semana com in√≠cio configur√°vel
    function getWeekStart(d){
      const rules = loadRules() || {};
      const start = (rules.weekStart || 'mon'); // 'mon'|'sun'
      d = new Date(d);
      const dow = d.getDay(); // 0 Dom..6 S√°b
      if(start === 'sun'){
        const diff = d.getDate() - dow; // volta at√© Domingo
        return new Date(d.setDate(diff));
      } else {
        const diff = d.getDate() - dow + (dow===0 ? -6 : 1); // vai at√© Segunda
        return new Date(d.setDate(diff));
      }
    }
    function daysOrder(){ // devolve array de 0..6 com in√≠cio em weekStart
      return (loadRules().weekStart==='sun')
        ? [0,1,2,3,4,5,6]
        : [1,2,3,4,5,6,0];
    }
    function weekdayLabel(idx){
      const map = ['Domingo','Segunda','Ter√ßa','Quarta','Quinta','Sexta','S√°bado'];
      return map[idx];
    }
    function formatDate(d){ return d.toLocaleDateString('pt-PT',{ day:'2-digit', month:'short' }); }

    // Regras de escolha base (sem rota√ß√£o/limites)
    function applyRulesToCandidates(candidatas, tipoKey, date, rules){
      if(!Array.isArray(candidatas) || !candidatas.length) return [];

      const {isVerao, isInverno} = isSummerWinter(date);
      const dow = date.getDay();

      const meals = rules.meals || {};
      const mealRule = meals[tipoKey] || {};
      const preferWords = splitComma(mealRule.prefer);

      const season = rules.season || {};
      const sazVerao   = isVerao   ? splitComma(season.verao)   : [];
      const sazInverno = isInverno ? splitComma(season.inverno) : [];

      const meatless = rules.meatless || {days:[], allowFish:true};
      const isMeatlessDay = Array.isArray(meatless.days) && meatless.days.includes(dow);
      const meatWords = ['carne','bife','vaca','porco','frango','peru','enchido','salsicha','presunto','fiambre'];
      const fishWords = ['peixe','atum','bacalhau','salm√£o','pescada','sardinha','dourada','robalo','marisco','camar√£o'];

      const extraLightForDinner = (tipoKey==='jantar' && mealRule.light) ? ['sopa','salada','peixe','grelhado','legumes'] : [];

      // filtra ‚Äúsem carne‚Äù
      let out = candidatas.filter(r => {
        if(!isMeatlessDay) return true;
        if(meatless.allowFish){
          const isMeat = recipeMatches(r, meatWords);
          const isFish = recipeMatches(r, fishWords);
          return !isMeat || isFish;
        }
        return !recipeMatches(r, meatWords) && !recipeMatches(r, fishWords);
      });

      // dedupe por t√≠tulo
      out = Array.from(new Map(out.map(r => [r.titulo.toLowerCase(), r])).values());

      // prioriza prefer√™ncias + sazonalidade
      const priorityWords = [...preferWords, ...extraLightForDinner, ...sazVerao, ...sazInverno];
      if(priorityWords.length){
        const preferidas = out.filter(r => recipeMatches(r, priorityWords));
        if(preferidas.length) out = preferidas;
      }

      return out;
    }

    // Rota√ß√£o e limites semanais
    function usedRecentlyTitles(days){
      if(!days) return new Set();
      const plano = lerPlano();
      const cutoff = new Date(); cutoff.setDate(cutoff.getDate()-days);
      const set = new Set();
      Object.entries(plano).forEach(([iso,obj])=>{
        const d = new Date(iso);
        if(d >= cutoff){
          Object.values(obj||{}).forEach(nome => { if(nome && nome !== '__NAO__') set.add(nome); });
        }
      });
      return set;
    }
    function inferGroup(rec){
      const t = ((rec.titulo||'') + ' ' + (rec.tags||[]).join(' ')).toLowerCase();
      if(/massa|massada|esparguete|espaguete|penne|macarr|gnoc|tagliat/i.test(t)) return 'massa';
      if(/peixe|atum|bacalhau|salm[a√£]o|pescad|dourada|robalo|sardinh|marisc|camar/i.test(t)) return 'peixe';
      if(/carne|bife|vaca|porco|frango|peru|entrecote|picanha|almondeg|salsich/i.test(t)) return 'carne';
      if(/sopa|caldo|creme/i.test(t)) return 'sopa';
      if(/salada|salad bowl|gaspacho/i.test(t)) return 'salada';
      return 'outros';
    }

    // Constru√ß√£o do calend√°rio
    let dataAtual = new Date();

    function buildHeadRow(startDate){
      const tr = document.getElementById('cal-head-row');
      tr.innerHTML = '';
      const th0 = document.createElement('th'); th0.textContent = 'Refei√ß√£o / Dia'; tr.appendChild(th0);

      const order = daysOrder();
      for(const dow of order){
        const d = new Date(startDate);
        // alinhar √≠ndice: se startDate n√£o √© o dow desejado, avan√ßa at√© l√°
        // (startDate j√° √© Sunday ou Monday; somar deslocamento relativo)
        const delta = (dow - startDate.getDay() + 7) % 7;
        d.setDate(startDate.getDate()+delta);
        const th = document.createElement('th');
        th.textContent = `${weekdayLabel(dow)} (${formatDate(d)})`;
        tr.appendChild(th);
      }
    }

    function atualizarCalendario(){
      const start = getWeekStart(dataAtual);
      const end   = new Date(start); end.setDate(start.getDate()+6);
      document.getElementById('semanaAtual').textContent = `${formatDate(start)} a ${formatDate(end)}`;
      buildHeadRow(start);

      const tbody = document.getElementById('calendarioCorpo');
      tbody.innerHTML = '';

      const order = daysOrder();

      for (let refeicao of refeicoes) {
        const tr = document.createElement('tr');
        const tdRefeicao = document.createElement('td');
        tdRefeicao.textContent = refeicao;
        tdRefeicao.style.fontWeight = '700';
        tr.appendChild(tdRefeicao);

        for (const dow of order){
          const d = new Date(start);
          const delta = (dow - start.getDay() + 7) % 7;
          d.setDate(start.getDate()+delta);
          const diaKey = d.toISOString().slice(0,10);

          const td = document.createElement('td');
          const slot = document.createElement('div');
          slot.className = 'slot';
          slot.tabIndex = 0; slot.setAttribute('role','button');
          slot.setAttribute('aria-label', `${refeicao} de ${weekdayLabel(dow)}, editar`);

          const receita = (planoSemanal[diaKey] && planoSemanal[diaKey][refeicao]) || '';
          const nao = receita === '__NAO__';
          slot.textContent = nao ? '‚Äî n√£o cozinhar ‚Äî' : (receita || '+ adicionar');
          if(nao) slot.classList.add('nao'); else slot.classList.remove('nao');

          slot.onclick = () => abrirModal(diaKey, refeicao);
          slot.onkeydown = (e) => { if(e.key==='Enter' || e.key===' ') abrirModal(diaKey, refeicao); };

          td.appendChild(slot); tr.appendChild(td);
        }
        tbody.appendChild(tr);
      }
    }

    // Modal
    const modal = document.getElementById('modalEdit');
    const inputReceita = document.getElementById('inputReceita');
    const datalist = document.getElementById('listaReceitas');
    const btnSalvar = document.getElementById('btnSalvar');
    const btnCancelar = document.getElementById('btnCancelar');
    const btnNaoCozinhar = document.getElementById('btnNaoCozinhar');
    const etiquetaTipo = document.getElementById('etiqueta-tipo');

    let editingDia = null, editingRefeicao = null;

    function abrirModal(dia, ref){
      editingDia = dia; editingRefeicao = ref;

      const tipoKey = tipoKeyFromLabel(ref);
      etiquetaTipo.textContent = `(${ref})`;
      const livro = lerLivroReceitas().filter(r => r.tipo === tipoKey);
      datalist.innerHTML = '';
      livro.forEach(r => {
        const opt = document.createElement('option');
        opt.value = r.titulo;
        datalist.appendChild(opt);
      });

      const atual = (planoSemanal[dia] && planoSemanal[dia][ref]) || '';
      inputReceita.value = (atual && atual !== '__NAO__') ? atual : '';
      modal.classList.add('active');
      inputReceita.focus();
      inputReceita.select();
    }

    function fecharModal(){ modal.classList.remove('active'); editingDia = null; editingRefeicao = null; }

    btnSalvar.onclick = () => {
      if(!editingDia || !editingRefeicao) return;
      const valor = inputReceita.value.trim();
      if(!planoSemanal[editingDia]) planoSemanal[editingDia] = {};
      planoSemanal[editingDia][editingRefeicao] = valor;
      gravarPlano(planoSemanal);
      fecharModal(); atualizarCalendario();
    };
    btnCancelar.onclick = fecharModal;
    btnNaoCozinhar.onclick = () => {
      if(!editingDia || !editingRefeicao) return;
      if(!planoSemanal[editingDia]) planoSemanal[editingDia] = {};
      planoSemanal[editingDia][editingRefeicao] = '__NAO__';
      gravarPlano(planoSemanal);
      fecharModal(); atualizarCalendario();
    };
    modal.onclick = (e) => { if(e.target === modal) fecharModal(); };

    // navega√ß√£o
    document.getElementById('prevWeek').onclick = () => { dataAtual.setDate(dataAtual.getDate()-7); atualizarCalendario(); };
    document.getElementById('nextWeek').onclick = () => { dataAtual.setDate(dataAtual.getDate()+7); atualizarCalendario(); };

    // Completar com regras + rota√ß√£o + limites
    document.getElementById('btnCompletar').onclick = () => {
      const start = getWeekStart(dataAtual);
      const livro  = lerLivroReceitas();
      const rules  = loadRules();

      // helpers para limites
      function weekCounters(){
        const counters = {massa:0, peixe:0, carne:0, sopa:0, salada:0, outros:0};
        const order = daysOrder();
        for(const dow of order){
          const d = new Date(start);
          const delta = (dow - start.getDay() + 7) % 7;
          d.setDate(start.getDate()+delta);
          const key = d.toISOString().slice(0,10);
          const obj = planoSemanal[key] || {};
          Object.values(obj).forEach(nome=>{
            const r = livro.find(x=>x.titulo===nome);
            if(r){ const g=inferGroup(r); counters[g] = (counters[g]||0)+1; }
          });
        }
        return counters;
      }

      const rotation = Math.max(0, rules.rotationDays||0);
      const recent = usedRecentlyTitles(rotation);
      const limits = (rules.limits||{});

      const order = daysOrder();

      for (const dow of order){
        const dia = new Date(start);
        const delta = (dow - start.getDay() + 7) % 7;
        dia.setDate(start.getDate()+delta);
        const diaKey = dia.toISOString().slice(0,10);
        if(!planoSemanal[diaKey]) planoSemanal[diaKey] = {};

        for (let ref of refeicoes) {
          const atual = planoSemanal[diaKey][ref];
          if (atual && atual.trim() !== '') continue; // s√≥ preenche vazios

          const tipoKey = tipoKeyFromLabel(ref);
          let candidatas = livro.filter(r => r.tipo === tipoKey);
          candidatas = applyRulesToCandidates(candidatas, tipoKey, dia, rules);

          // aplica rota√ß√£o e limites
          let poolBase = candidatas.length ? candidatas : receitasExemplo.filter(r => r.tipo === tipoKey);

          // counters atualizados a cada slot
          const counters = weekCounters();

          // 1) remove as usadas recentemente
          let pool = poolBase.filter(r => !recent.has(r.titulo));

          // 2) prioriza grupos com m√≠nimos por cumprir
          const groupsNeedingMin = Object.entries(limits)
            .filter(([g,v]) => (v.min||0) > (counters[g]||0))
            .map(([g])=>g);
          if(groupsNeedingMin.length){
            const prefer = pool.filter(r => groupsNeedingMin.includes(inferGroup(r)));
            if(prefer.length) pool = prefer;
          }

          // 3) bloqueia grupos que atingiram o m√°ximo
          pool = pool.filter(r => {
            const g = inferGroup(r);
            const cap = (limits[g]?.max ?? Infinity);
            return (counters[g]||0) < cap;
          });

          // fallback
          if(!pool.length) pool = poolBase;

          const escolhida = pool[Math.floor(Math.random()*pool.length)].titulo;
          planoSemanal[diaKey][ref] = escolhida;
        }
      }

      gravarPlano(planoSemanal);
      atualizarCalendario();
    };

    // Exportar PDF
    document.getElementById('btnExportar').onclick = () => window.print();

    // Gerar lista de compras (sem categorias; agrega ‚ÄúOutros‚Äù)
    document.getElementById('btnGerarCompras').onclick = () => {
      const livro  = lerLivroReceitas();
      const byName = Object.fromEntries(livro.map(r => [r.titulo, r]));
      const lista  = lerLista();
      if (!lista['Outros']) lista['Outros'] = [];

      const norm = (s) => (s || '')
        .toLowerCase()
        .replace(/^[\-\‚Äì‚Ä¢\*]\s*/,'')
        .replace(/\s{2,}/g,' ')
        .replace(/[.,;:]\s*$/,'')
        .trim();

      // remove itens antigos de origem "plano"
      Object.keys(lista).forEach(cat => {
        lista[cat] = (lista[cat] || []).filter(i => (i.src || 'manual') !== 'plano');
        if (!lista[cat].length && cat !== 'Outros') delete lista[cat];
      });

      const start = getWeekStart(dataAtual);
      const order = daysOrder();

      for (const dow of order) {
        const d = new Date(start);
        const delta = (dow - start.getDay() + 7) % 7;
        d.setDate(start.getDate() + delta);
        const diaKey = d.toISOString().slice(0, 10);
        const obj    = planoSemanal[diaKey] || {};

        for (const ref of refeicoes) {
          const nome = obj[ref];
          if (!nome || nome === '__NAO__') continue;

          const rec = byName[nome];
          if (!rec || !rec.ingredientes) continue;

          rec.ingredientes
            .split('\n')
            .map(l => l.trim())
            .filter(Boolean)
            .forEach(raw => {
              const key = norm(raw);
              if (!key) return;
              const cat = 'Outros';
              const ix = lista[cat].findIndex(i => (i.src || 'manual') === 'plano' && i.key === key);
              if (ix === -1) {
                const display = raw.replace(/^[\-\‚Äì‚Ä¢\*]\s*/,'').trim();
                lista[cat].push({ nome: display, key, quantidade: '', comprado: false, src: 'plano' });
              }
            });
        }
      }

      gravarLista(lista);
      if (confirm('Lista de compras gerada a partir do plano desta semana. Queres abrir a Lista de Compras agora?')) {
        location.href = 'listaCompras.html';
      }
    };

    atualizarCalendario();
  </script>
</body>
</html>
