<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Receitas - MealMaster</title>

  <link rel="stylesheet" href="style.css" />
  <style>
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background:#fffde7; color:#4e342e; margin:0; }

    /* ‚Üë alargado para caberem 4 cards confortavelmente */
    main { max-width: 1280px; margin: 30px auto; padding: 20px 40px; }

    .toolbar { display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap; margin-bottom:16px; }
    .toolbar h2 { margin:0; }
    .toolbar .actions { display:flex; gap:10px; flex-wrap:wrap; }

    .btn{border:0;border-radius:28px;padding:10px 16px;font-weight:800;cursor:pointer;background:#ffcc80;color:#4e342e;box-shadow:0 2px 6px rgba(0,0,0,.08)}
    .btn:hover{filter:brightness(1.03)}
    .btn--brand{background:linear-gradient(90deg,#ffb347,#ffcc33); color:#6d4c41; box-shadow:0 6px 14px rgba(255,179,71,.45)}
    .btn--brand:hover{filter:brightness(1.06)}
    .btn--ghost{background:#fffde7;border:1.5px solid #ffb74d}
    .btn--danger{background:#e57373; color:#fff}

    .filtros { background:#fff9c4; padding:20px; border-radius:10px; margin-bottom:30px; box-shadow:0 3px 7px rgba(255,183,77,.5); }
    .filtros > div { margin-bottom:15px; }
    label { font-weight:600; display:block; margin-bottom:8px; }
    .tipo-receita { display:flex; gap:10px; flex-wrap:wrap; }
    .tipo-receita button { background:#ffb74d; border:0; padding:10px 18px; border-radius:25px; font-weight:700; cursor:pointer; color:#4e342e; }
    .tipo-receita button.active, .tipo-receita button:hover { background:#4caf50; color:#fff; }
    input[type="text"], input[type="url"] { padding:8px 12px; border-radius:8px; border:1.5px solid #ffb74d; font-weight:600; color:#4e342e; width:100%; box-sizing:border-box; background:#fffde7;}
    textarea { width:100%; border:1.5px solid #ffb74d; border-radius:8px; padding:8px 12px; font-weight:600; color:#4e342e; background:#fffde7; box-sizing:border-box; }

    /* ===== TAGS ===== */
    .tags{ display:flex; flex-wrap:wrap; gap:8px; max-height:120px; overflow:auto; }
    #lista-tags:empty{ display:none; }
    #lista-tags:not(:empty){ padding:8px 12px; border:1.5px solid #ffb74d; border-radius:8px; background:#fffde7; }
    .tag { background:#4caf50; color:#fff; padding:6px 12px; border-radius:20px; cursor:pointer; user-select:none; font-weight:600; }
    .tag.selected { background:#1b5e20; }

    /* ===== GRELHA: 3‚Äì4 por linha em desktop; responsiva ‚Üì ===== */
    .receitas-grid{
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap:20px;
    }
    /* for√ßa 4 colunas quando houver espa√ßo suficiente */
    @media (min-width: 1200px){
      .receitas-grid{ grid-template-columns: repeat(4, 1fr); }
    }

    .receita-card { background:#fff; border-radius:12px; box-shadow:0 2px 6px rgba(0,0,0,.1); overflow:hidden; position:relative; }
    .receita-img { width:100%; height:150px; object-fit:cover; background:#fffde7; }
    .receita-body { padding:12px 12px 14px; }
    .receita-titulo { margin:0 0 6px; font-weight:800; font-size:1.05rem; color:#4e342e; }
    .r-meta { font-size:.9rem; color:#6d4c41; opacity:.85; }
    .card-actions{display:flex; gap:8px; margin-top:10px; flex-wrap:wrap}

    .modal-bg{position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.35); z-index:999}
    .modal-bg.active{display:flex}
    .modal{background:#fffde7; border-radius:16px; width:min(800px,94vw); padding:18px 18px 16px; box-shadow:0 10px 30px rgba(0,0,0,.3)}
    .modal h3{margin:0 0 12px; font-size:1.4rem}
    .grid-2{display:grid; grid-template-columns: 1fr 1fr; gap:12px}
    .modal .form-row{margin-bottom:12px}
    .modal .actions{display:flex; gap:10px; justify-content:flex-end; margin-top:10px}
    @media (max-width:720px){ .grid-2{grid-template-columns:1fr} }
  </style>
</head>


<body>

  <header>
    <h1>MealMaster</h1>
    <a href="perfil.html" class="profile-icon" title="Abrir perfil" aria-label="Abrir perfil">üë§</a>
  </header>

  <nav class="sidebar" role="navigation" aria-label="Menu principal">
    <a href="index.html"     data-route="index.html">Menu Principal</a>
    <a href="receitas.html"  data-route="receitas.html">Receitas</a>
    <a href="calendario.html"data-route="calendario.html">Plano Semanal</a>
    <a href="listaCompras.html" data-route="listaCompras.html">Lista de Compras</a>
    <a href="configuracoes.html" data-route="configuracoes.html">Configura√ß√µes</a>
  </nav>

  <script>
    // ativa link atual no menu
    (function () {
      const here = location.pathname.split('/').pop() || 'index.html';
      document.querySelectorAll('.sidebar a').forEach(a => {
        if (a.getAttribute('data-route') === here) {
          a.classList.add('active'); a.setAttribute('aria-current', 'page');
        }
      });
    })();
  </script>

  <!-- redireciona n√£o autenticados -->
  <script type="module">
    import { auth } from './firebase.js';
    import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";
    onAuthStateChanged(auth, (u)=>{ if(!u) location.href='index.html'; });
  </script>

  <main>
    <div class="toolbar">
      <h2>Receitas</h2>
      <div class="actions">
        <button class="btn btn--brand" id="btn-nova-receita">+ Adicionar Nova Receita</button>
      </div>
    </div>

    <section class="filtros" aria-label="Filtros de receitas">
      <div>
        <label for="filtro-alergias">Alergias (separar por v√≠rgulas)</label>
        <input id="filtro-alergias" type="text" placeholder="ex: amendoim, gl√∫ten, lactose" />
      </div>

      <div>
        <label>Tipo de receita</label>
        <div class="tipo-receita" role="list" aria-label="Tipos de receita">
          <button type="button" class="active" data-tipo="todos">Todos</button>
          <button type="button" data-tipo="pequeno-almoco">Pequenos-almo√ßos</button>
          <button type="button" data-tipo="almoco">Almo√ßos</button>
          <button type="button" data-tipo="lanche">Lanches</button>
          <button type="button" data-tipo="jantar">Jantares</button>
          <button type="button" data-tipo="ceia">Ceia</button>
        </div>
      </div>

      <div>
        <label>Tags (ingredientes, dietas, etc.)</label>
        <input type="text" id="pesquisa-tags" placeholder="Pesquisar tags..." aria-label="Pesquisar tags" />
        <div class="tags" id="lista-tags" role="listbox" aria-multiselectable="true" tabindex="0"></div>
      </div>
    </section>

    <section class="receitas-grid" aria-live="polite" aria-atomic="true"></section>
  </main>

  <!-- MODAL -->
  <div class="modal-bg" id="modal-bg">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <h3 id="modalTitle">Nova Receita</h3>
      <form id="form-receita">
        <div class="grid-2">
          <div class="form-row">
            <label for="f-titulo">T√≠tulo</label>
            <input id="f-titulo" type="text" required placeholder="Ex.: Bacalhau √† Gomes de S√°" />
          </div>
          <div class="form-row">
            <label for="f-tipo">Tipo</label>
            <select id="f-tipo" required style="width:100%;padding:8px 12px;border-radius:8px;border:1.5px solid #ffb74d;background:#fffde7;font-weight:600;color:#4e342e">
              <option value="pequeno-almoco">Pequeno-almo√ßo</option>
              <option value="almoco">Almo√ßo</option>
              <option value="lanche">Lanche</option>
              <option value="jantar">Jantar</option>
              <option value="ceia">Ceia</option>
            </select>
          </div>
          <div class="form-row">
            <label for="f-tags">Tags (separar por v√≠rgulas)</label>
            <input id="f-tags" type="text" placeholder="ex.: r√°pido, baixo custo, vegetariano" />
          </div>
          <div class="form-row">
            <label for="f-img">URL da imagem (opcional)</label>
            <input id="f-img" type="url" placeholder="https:// ..." />
          </div>
        </div>

        <div class="form-row">
          <label for="f-ingredientes">Ingredientes</label>
          <textarea id="f-ingredientes" rows="3" placeholder="- 500g bacalhau&#10;- 4 batatas&#10;- azeite ..."></textarea>
        </div>
        <div class="form-row">
          <label for="f-passos">Passos</label>
          <textarea id="f-passos" rows="4" placeholder="1) Cozer as batatas...&#10;2) ..."></textarea>
        </div>

        <div class="actions">
          <button type="button" class="btn" id="btn-cancelar">Cancelar</button>
          <button type="submit" class="btn btn--brand" id="btn-gravar">Gravar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- L√ìGICA: Firestore-only -->
  <script type="module">
    import { auth, getAllRecipes, saveRecipe, deleteRecipe } from './firebase.js';
    import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";

    const FALLBACK_IMG = 'https://images.unsplash.com/photo-1504754524776-8f4f37790ca0?auto=format&fit=crop&w=400&q=60';

    let UID = null;
    let cacheLivro = [];

    async function carregarLivro(){
      cacheLivro = await getAllRecipes(UID);
      return cacheLivro;
    }
    const obterReceitas = () => cacheLivro;

    // ======= Refs UI =======
    const listaTags = document.getElementById('lista-tags');
    const receitasGrid = document.querySelector('.receitas-grid');
    const filtroAlergias = document.getElementById('filtro-alergias');
    const tipoBtns = document.querySelectorAll('.tipo-receita button');
    const pesquisaTagsInput = document.getElementById('pesquisa-tags');

    const modalBg = document.getElementById('modal-bg');
    const form = document.getElementById('form-receita');
    const fTitulo = document.getElementById('f-titulo');
    const fTipo = document.getElementById('f-tipo');
    const fTags = document.getElementById('f-tags');
    const fImg = document.getElementById('f-img');
    const fIng = document.getElementById('f-ingredientes');
    const fPassos = document.getElementById('f-passos');
    const btnCancelar = document.getElementById('btn-cancelar');
    const modalTitle = document.getElementById('modalTitle');

    const tagsDisponiveis = ['vegetariano','vegan','gl√∫ten','lactose','amendoim','baixo carboidrato','r√°pido','baixo custo','alta prote√≠na','sem a√ß√∫car','sem lactose','pescatariano'];

    let filtroTipo = 'todos';
    const tagsSelecionadas = new Set();
    let editId = null;

    // ======= Tags =======
    function renderizarTags(filtro = '') {
      listaTags.innerHTML = '';
      const f = filtro.toLowerCase();
      tagsDisponiveis
        .filter(tag => tag.toLowerCase().includes(f))
        .forEach(tag => {
          const btn = document.createElement('button');
          btn.type = 'button';
          btn.className = 'tag';
          btn.textContent = tag;
          if (tagsSelecionadas.has(tag)) btn.classList.add('selected');
          btn.addEventListener('click', () => {
            if (tagsSelecionadas.has(tag)) { tagsSelecionadas.delete(tag); btn.classList.remove('selected'); }
            else { tagsSelecionadas.add(tag); btn.classList.add('selected'); }
            filtrarReceitas();
          });
          listaTags.appendChild(btn);
        });
    }

    // ======= Render grid =======
    function traduzTipo(t){
      return ({'pequeno-almoco':'Pequeno-almo√ßo','almoco':'Almo√ßo','lanche':'Lanche','jantar':'Jantar','ceia':'Ceia'}[t] || t);
    }

    function filtrarReceitas() {
      const alergias = filtroAlergias.value.toLowerCase().split(',').map(a=>a.trim()).filter(Boolean);
      const base = obterReceitas();
      receitasGrid.innerHTML = '';

      const receitasFiltradas = base.filter(r=>{
        if (filtroTipo!=='todos' && r.tipo!==filtroTipo) return false;
        for (const t of tagsSelecionadas) if(!r.tags?.includes(t)) return false;
        for (const a of alergias) if (r.tags?.some(tag => tag.toLowerCase()===a)) return false;
        return true;
      });

      if(!receitasFiltradas.length){
        receitasGrid.innerHTML = '<p>Nenhuma receita encontrada com os filtros aplicados.</p>';
        return;
      }

      receitasFiltradas.forEach(r => {
        const card = document.createElement('article');
        card.className = 'receita-card';
        card.innerHTML = `
          <img src="${r.img || FALLBACK_IMG}" alt="Imagem da receita ${r.titulo}" class="receita-img" />
          <div class="receita-body">
            <h3 class="receita-titulo">${r.titulo}</h3>
            <div class="r-meta">${traduzTipo(r.tipo)} ¬∑ ${r.tags?.slice(0,3).join(', ') || 'sem tags'}</div>
            <div class="card-actions">
              <button class="btn btn--ghost btn-editar">Editar</button>
              <button class="btn btn--danger btn-eliminar">Eliminar</button>
            </div>
          </div>
        `;

        card.querySelector('.btn-editar').addEventListener('click', (e) => {
          e.stopPropagation(); abrirModalEditar(r);
        });
        card.querySelector('.btn-eliminar').addEventListener('click', async (e) => {
          e.stopPropagation(); await eliminarReceita(r.id);
        });

        card.addEventListener('click', () => { location.href = `receita.html?id=${r.id}`; });
        card.setAttribute('role', 'button');
        card.tabIndex = 0;
        card.addEventListener('keydown', (e) => {
          if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); location.href = `receita.html?id=${r.id}`; }
        });

        receitasGrid.appendChild(card);
      });
    }

    // ======= Modal criar/editar =======
    function abrirModalNovo(){
      editId = null;
      modalTitle.textContent = 'Nova Receita';
      form.reset();
      modalBg.classList.add('active');
      fTitulo.focus();
    }
    function abrirModalEditar(r){
      editId = r.id;
      modalTitle.textContent = 'Editar Receita';
      fTitulo.value = r.titulo || '';
      fTipo.value = r.tipo || 'almoco';
      fTags.value = (r.tags || []).join(', ');
      fImg.value = r.img || '';
      fIng.value = r.ingredientes || '';
      fPassos.value = r.passos || '';
      modalBg.classList.add('active');
      fTitulo.focus();
    }
    function fecharModal(){ modalBg.classList.remove('active'); }

    document.getElementById('btn-nova-receita').addEventListener('click', abrirModalNovo);
    btnCancelar.addEventListener('click', fecharModal);
    modalBg.addEventListener('click', (e)=>{ if(e.target===modalBg) fecharModal(); });

    form.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const receita = {
        id: editId || crypto.randomUUID(),
        titulo: fTitulo.value.trim(),
        title:  fTitulo.value.trim(),
        tipo: fTipo.value,
        tags: (fTags.value||'').split(',').map(t=>t.trim()).filter(Boolean),
        img: fImg.value.trim(),
        ingredientes: fIng.value.trim(),
        passos: fPassos.value.trim()
      };
      await saveRecipe(UID, receita);
      fecharModal();
      await carregarLivro();
      filtrarReceitas();
    });

    async function eliminarReceita(id){
      if(!confirm('Eliminar esta receita?')) return;
      await deleteRecipe(UID, id);
      await carregarLivro();
      filtrarReceitas();
    }

    // ======= Filtros =======
    filtroAlergias.addEventListener('input', filtrarReceitas);
    document.querySelectorAll('.tipo-receita button').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        document.querySelectorAll('.tipo-receita button').forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
        filtroTipo = btn.dataset.tipo;
        filtrarReceitas();
      });
    });
    document.getElementById('pesquisa-tags').addEventListener('input', (e)=> renderizarTags(e.target.value));

    (function aplicarQueryString(){
      const q = new URLSearchParams(location.search).get('q');
      if(q){ document.getElementById('pesquisa-tags').value = q; renderizarTags(q); }
    })();

    // ======= Boot (autenticado) =======
    renderizarTags();
    filtrarReceitas();

    onAuthStateChanged(auth, async (u)=>{
      if(!u) return; // redireciona j√° no script acima
      UID = u.uid;
      await carregarLivro();
      renderizarTags();
      filtrarReceitas();
    });
  </script>

</body>
</html>
