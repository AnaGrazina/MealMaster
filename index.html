<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MealMaster</title>
  <link rel="stylesheet" href="style.css" />
  <meta name="theme-color" content="#4caf50" />
  <style>
    [hidden]{display:none!important;visibility:hidden!important}

    :root{
      --brand:#4caf50; --brand-d:#2e7d32; --soft:#fffde7; --ink:#4e342e;
      --accent: linear-gradient(90deg,#ffb347,#ffcc33);
      --ring: 0 0 0 3px rgba(76,175,80,.18);
      --glass: rgba(255,255,255,.6);
    }
    .page-title{margin:0 0 4px;font-size:1.8rem;font-weight:900}
    .page-sub{margin:0;opacity:.75;font-weight:600}

    /* cart√µes mais clean */
    .pretty-card{
      background: linear-gradient(180deg, rgba(255,255,255,.86), rgba(255,255,255,.74));
      backdrop-filter: blur(6px);
      border: 1px solid #ece7df;
      box-shadow: 0 10px 22px rgba(0,0,0,.06);
      border-radius: 16px;
    }
    .card.pretty-card{padding:16px 18px}

    /* HERO (login) */
    .hero{
      display:grid;grid-template-columns:1.3fr .7fr;gap:24px;
      background:
        radial-gradient(1200px 400px at -10% -20%, #ffe7ba, transparent),
        radial-gradient(1000px 400px at 120% 120%, #c8f7d1, transparent),
        linear-gradient(135deg,#fff,#fffdf3);
      padding:24px;margin:28px auto;max-width:760px;
    }
    .hero__left{padding:6px 10px 10px}
    .hero__title{margin:0 0 6px;font-size:1.6rem;font-weight:900}
    .hero__desc{margin:0 0 14px;color:#5d4037}
    .auth-actions{display:flex;align-items:center;justify-content:space-between;margin-top:12px}
    .chip{padding:6px 10px;border-radius:999px;background:#e8f5e9;color:#1b5e20;font-weight:800}
    .loginform{display:grid;gap:10px}
    .input-wrap{display:flex;align-items:center;gap:8px;background:#fff;border:1.5px solid #ffb74d;border-radius:12px;padding:8px 10px}
    .input-wrap input{border:0;outline:0;flex:1;font-weight:700;color:var(--ink);background:transparent}
    .input-wrap:focus-within{box-shadow:var(--ring)}
    .i{opacity:.8;font-size:1rem}
    .btn--full{width:100%}
    .btn--danger{background:#e57373;color:#fff}
    a.btn{text-decoration:none}
    a.btn:link,a.btn:visited{color:inherit}

    /* Dashboard */
    #dashboard{margin:24px 40px;padding:0 0 40px}
    .dash-top{display:flex;gap:18px;justify-content:space-between;align-items:center;flex-wrap:wrap;padding:16px 18px}
    .qsearch{display:flex;align-items:center;gap:10px;background:#fff;border:1.5px solid #ffb74d;border-radius:999px;padding:6px 10px}
    .qsearch input{border:0;outline:0;min-width:220px;font-weight:700;background:transparent}
    .qsearch:focus-within{box-shadow:var(--ring)}
    @media (max-width:640px){.qsearch button{display:none}}

    .shortcuts-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px;margin:16px 0 18px}

    /* Atalhos comuns */
    .shortcut{
      display:flex;align-items:center;gap:12px;
      padding:16px 18px;border-radius:16px;
      background:linear-gradient(180deg,#fff,#faf8f3);
      border:1px solid #ece7df; box-shadow:0 10px 22px rgba(0,0,0,.06);
      text-decoration:none; color:inherit; font-weight:900;
      transition: transform .15s ease, box-shadow .15s ease, border-color .15s ease;
    }
    .shortcut:hover{ transform:translateY(-2px); box-shadow:0 14px 26px rgba(0,0,0,.08); border-color:#e6e0d6;}
    .shortcut:focus-visible{ outline:none; box-shadow: 0 0 0 3px rgba(76,175,80,.18); }
    .shortcut .sicon{
      width:36px;height:36px;border-radius:10px;display:grid;place-items:center;
      font-size:1.15rem;background:linear-gradient(135deg,#eef7f0,#fff);border:1px solid #dfeadf;color:#2e7d32;flex-shrink:0;
    }
    .shortcut .label{ font-weight:900 }
    .shortcut .spacer{ flex:1 }

    .pill{display:inline-block;margin-left:8px;min-width:22px;padding:2px 7px;border-radius:999px;background:#e76a6a;color:#fff;text-align:center;font-weight:800}
    .link{display:inline-block;font-weight:800;text-decoration:none;color:var(--ink)}
    .link:hover{text-decoration:underline}
  </style>
</head>
<body>
  <header>
    <h1>MealMaster</h1>
    <div style="display:flex;gap:.5rem;align-items:center">
      <span id="userEmailTop" style="font-weight:700"></span>
      <button id="logoutTop" class="btn" style="display:none;background:#e57373;color:#fff;padding:.35rem .7rem">Sair</button>
      <a href="perfil.html" class="profile-icon" title="Abrir perfil" aria-label="Abrir perfil">üë§</a>
    </div>
  </header>

  <nav class="sidebar" role="navigation" aria-label="Menu principal">
    <a href="index.html" data-route="index.html">Menu Principal</a>
    <a href="receitas.html" data-route="receitas.html">Receitas</a>
    <a href="calendario.html" data-route="calendario.html">Plano Semanal</a>
    <a href="listaCompras.html" data-route="listaCompras.html">Lista de Compras</a>
    <a href="configuracoes.html" data-route="configuracoes.html">Configura√ß√µes</a>
  </nav>

  <!-- LOGIN -->
  <section id="authBox" class="card hero" hidden>
    <div class="hero__left">
      <h2 class="hero__title">Entra no teu MealMaster</h2>
      <p class="hero__desc">
        Usa um <b>nome de utilizador</b> no <b>formato e-mail</b> (ex.: ana@teste.com).
        N√£o precisa de ser real ‚Äî serve s√≥ para identificar a tua conta.
        A palavra-passe deve ter <b>m√≠n. 6 caracteres</b>. Se n√£o tens conta, √© criada automaticamente.
      </p>

      <form id="loginForm" class="loginform">
        <div class="input-wrap">
          <span class="i">‚úâÔ∏è</span>
          <input id="email" type="email" placeholder="email@exemplo.com" required>
        </div>
        <div class="input-wrap">
          <span class="i">üîí</span>
          <input id="pass" type="password" placeholder="password" minlength="6" required>
        </div>
        <button class="btn btn--brand btn--full">Entrar / Criar conta</button>
      </form>

      <div id="authActions" hidden class="auth-actions">
        <span id="userEmail" class="chip"></span>
        <button id="logoutBtn" class="btn btn--danger">Sair</button>
      </div>
    </div>

    <div class="hero__right" aria-hidden="true">
      <div class="hero-ill">
        <div class="hero-plate"></div>
        <div class="hero-steam s1"></div>
        <div class="hero-steam s2"></div>
        <div class="hero-steam s3"></div>
      </div>
    </div>
  </section>

  <script>
    (function(){
      const here = location.pathname.split('/').pop() || 'index.html';
      document.querySelectorAll('.sidebar a').forEach(a=>{
        if(a.getAttribute('data-route')===here){ a.classList.add('active'); a.setAttribute('aria-current','page'); }
      });
    })();
  </script>

  <main id="dashboard" hidden>
    <div class="dash-top pretty-card">
      <div>
        <h2 class="page-title">Bem-vindo(a) ao MealMaster! üëã</h2>
        <p class="page-sub">Organiza a semana, descobre ideias e mant√©m a tua lista de compras em dia.</p>
      </div>

      <form id="quick-search" role="search" aria-label="Pesquisar receitas" class="qsearch">
        <span class="i">üîé</span>
        <input id="qs-input" type="search" placeholder="Procurar receita..." list="qs-sugestoes" />
        <datalist id="qs-sugestoes"></datalist>
        <button class="btn btn--brand" type="submit">Pesquisar</button>
      </form>
    </div>

    <!-- S√ì os 3 atalhos -->
    <section class="shortcuts-grid">
      <a class="shortcut pretty-card" href="receitas.html" aria-label="Adicionar receita">
        <span class="sicon">üç≥</span>
        <span class="label">Adicionar receita</span>
      </a>

      <a class="shortcut pretty-card" href="calendario.html" aria-label="Abrir plano semanal">
        <span class="sicon">üìÖ</span>
        <span class="label">Abrir plano semanal</span>
      </a>

      <a class="shortcut pretty-card" href="listaCompras.html" aria-label="Abrir lista de compras">
        <span class="sicon">üõí</span>
        <span class="label">Lista de compras</span>
        <span class="spacer"></span>
        <span id="badge-compras" class="pill" aria-label="Itens por comprar" aria-live="polite"></span>
      </a>
    </section>
  </main>

  <script type="module">
    import { auth, loginEmail, logout, getShoppingList } from './firebase.js';
    import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";

    const authBox = document.getElementById('authBox');
    const dashboardBox = document.getElementById('dashboard');
    const emailIn = document.getElementById('email');
    const passIn  = document.getElementById('pass');
    const actions = document.getElementById('authActions');
    const userEmail = document.getElementById('userEmail');
    const userEmailTop = document.getElementById('userEmailTop');
    const logoutBtn = document.getElementById('logoutBtn');
    const logoutTop = document.getElementById('logoutTop');

    const badgeCompras = document.getElementById('badge-compras');

    let UID=null, LISTA=[];
    const lerLista = () => (Array.isArray(LISTA) ? LISTA : []);

    function readListFromLS(){
      try{
        const obj = JSON.parse(localStorage.getItem('mealmaster_listaCompras')) || {};
        return Object.values(obj).flat().map(i=>({
          nome:i?.nome||'', quantidade:i?.quantidade||'', comprado:!!i?.comprado, src:i?.src??null, key:i?.key??null
        }));
      }catch{ return []; }
    }

    function renderBadge(){
      const src = lerLista();
      const base = Array.isArray(src)&&src.length ? src : readListFromLS();
      const pendentes = base.filter(i=>!i.comprado).length;
      badgeCompras.textContent = pendentes ? pendentes : '';
      badgeCompras.style.display = pendentes ? 'inline-block' : 'none';
    }
    window.addEventListener('storage', ev=>{ if(ev.key==='mealmaster_listaCompras') renderBadge(); });

    // pesquisa r√°pida
    document.getElementById('quick-search')?.addEventListener('submit', e=>{
      e.preventDefault();
      const q=(document.getElementById('qs-input').value||'').trim();
      location.href = q ? `receitas.html?q=${encodeURIComponent(q)}` : 'receitas.html';
    });
    function fillDatalist(){
      document.getElementById('qs-sugestoes').innerHTML='';
    }

    document.getElementById('loginForm')?.addEventListener('submit', async e=>{
      e.preventDefault();
      try{ await loginEmail(emailIn.value.trim(), passIn.value); emailIn.value=''; passIn.value=''; }
      catch(err){ alert((err.message||'').replace('Firebase:','').trim()); }
    });
    const doLogout=()=>logout();
    document.getElementById('logoutBtn')?.addEventListener('click',doLogout);
    document.getElementById('logoutTop')?.addEventListener('click',doLogout);

    onAuthStateChanged(auth, async u=>{
      const logged=!!u;

      if(logged){ authBox.hidden=true; authBox.style.display='none'; dashboardBox.hidden=false; dashboardBox.style.display=''; }
      else{ authBox.hidden=false; authBox.style.display=''; dashboardBox.hidden=true; dashboardBox.style.display='none'; }

      if(actions) actions.hidden=!logged;

      logoutTop.style.display = logged ? 'inline-block' : 'none';
      userEmailTop.textContent = logged ? (u?.email || '') : '';
      userEmail.textContent    = logged ? (u?.email || '') : '';

      if(!logged) return;

      UID=u.uid;

      // S√≥ buscamos a LISTA
      const lista = await getShoppingList(UID).catch(()=>[]);
      const arrFS = Array.isArray(lista) ? lista : (Array.isArray(lista?.items) ? lista.items : []);
      LISTA = arrFS.length ? arrFS : readListFromLS();

      renderBadge();
      fillDatalist();
    });
  </script>
</body>
</html>
