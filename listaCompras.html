<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MealMaster - Lista de Compras</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    /* ===== EcrÃ£ ===== */
    main { padding:30px 40px; color:#4e342e; }
    h2 { margin:0 0 16px; font-weight:800; font-size:1.9rem; }
    .toolbar { display:flex; gap:10px; flex-wrap:wrap; margin:10px 0 22px; align-items:flex-end }
    .field { display:flex; flex-direction:column; gap:6px }
    .btn{border:0;border-radius:28px;padding:10px 16px;font-weight:800;cursor:pointer;background:#ffcc80;color:#4e342e;box-shadow:0 2px 6px rgba(0,0,0,.08)}
    .btn--brand{background:linear-gradient(90deg,#4caf50,#81c784); color:#fffde7; box-shadow:0 6px 14px rgba(129,199,132,.45)}
    .btn--ghost{background:#fffde7;border:1.5px solid #ffb74d}
    .btn--danger{background:#e57373;color:#fff}

    ul.lista { list-style:none; margin-top:10px; }
    ul.lista li {
      background:#fff3e0; margin-bottom:12px; padding:12px 15px; border-radius:12px;
      display:flex; align-items:center; gap:12px; box-shadow:0 1px 3px rgba(255,183,77,.4)
    }
    ul.lista li.comprado { background:#c8e6c9; text-decoration:line-through; color:#4e342e99; }

    .checkbox-container{position:relative;width:22px;height:22px;flex-shrink:0}
    .checkbox-container input{width:22px;height:22px;opacity:0;position:absolute;top:0;left:0;z-index:2;cursor:pointer}
    .custom-checkbox{width:22px;height:22px;border:2px solid #4caf50;border-radius:5px;display:inline-block}
    .checkbox-container input:checked + .custom-checkbox{
      background:#4caf50;border-color:#4caf50;
      background-image:url("data:image/svg+xml,%3csvg fill='white' viewBox='0 0 24 24' xmlns='http://www.w3.org/2000/svg'%3e%3cpath d='M20.285 6.708l-11.34 11.34-5.227-5.227 1.414-1.414 3.813 3.813 9.926-9.926z'/%3e%3c/svg%3e");
      background-repeat:no-repeat;background-position:center;background-size:16px 16px;
    }

    .nome{ flex:1; font-weight:700; }
    .qtd{ width:90px; padding:6px 8px; border:1.5px solid #ffb74d; border-radius:8px; text-align:center; color:#4e342e; font-weight:600; background:#fffde7 }
    .btn-eliminar{ background:#e57373; border:0; border-radius:8px; padding:6px 10px; color:#fff; font-weight:800; cursor:pointer; box-shadow:0 2px 5px rgba(229,115,115,.7) }
    .empty{ opacity:.7; font-style:italic; margin-top:12px }

    /* texto mais pequeno dos ingredientes */
    ul.lista li .nome{ font-size: .80rem; line-height:1.25; }
    @media (max-width: 600px){ ul.lista li .nome{ font-size: .95rem; } }

    /* ===== PRINT ===== */
    @page { size: A4 portrait; margin: 14mm; }
    @media print {
      html, body { background:#fff !important; color:#000 !important; }
      header, nav.sidebar, .toolbar, #btn-partilhar, .btn, .btn-eliminar { display:none !important; }
      main { padding:0 !important; margin:0 !important; }
      h2 { margin:0 0 6mm 0 !important; text-align:center; font-size:12pt !important; font-weight:700 !important; color:#000 !important; }
      ul.lista { margin: 0 !important; padding: 0 !important; }
      ul.lista li {
        break-inside: avoid; page-break-inside: avoid;
        background: transparent !important; box-shadow:none !important; border:0 !important; border-radius:0 !important;
        margin: 0 0 3.2mm 0 !important; padding: 0 !important;
        display: grid !important; grid-template-columns: 5mm 1fr auto; align-items: center; gap: 4mm !important;
      }
      ul.lista li::before { content:""; width:4.2mm; height:4.2mm; border:1px solid #000; display:inline-block; }
      .checkbox-container { display:none !important; }
      .nome, .qtd { color:#000 !important; }
      .qtd { font: inherit !important; background: transparent !important; border:0 !important; box-shadow:none !important; width:auto !important; min-width:16mm !important; text-align:right !important; }
      ul.lista li.comprado { text-decoration:none !important; color:#000 !important; }
    }
  </style>
</head>
<body>
  <header>
    <h1>MealMaster</h1>
    <a href="perfil.html" class="profile-icon" title="Abrir perfil" aria-label="Abrir perfil">ðŸ‘¤</a>
  </header>

  <nav class="sidebar" role="navigation" aria-label="Menu principal">
    <a href="index.html" data-route="index.html">Menu Principal</a>
    <a href="receitas.html" data-route="receitas.html">Receitas</a>
    <a href="calendario.html" data-route="calendario.html">Plano Semanal</a>
    <a href="listaCompras.html" data-route="listaCompras.html">Lista de Compras</a>
    <a href="configuracoes.html" data-route="configuracoes.html">ConfiguraÃ§Ãµes</a>
  </nav>

  <script>
    (function () {
      const here = location.pathname.split('/').pop() || 'index.html';
      document.querySelectorAll('.sidebar a').forEach(a => {
        if (a.getAttribute('data-route') === here) {
          a.classList.add('active'); a.setAttribute('aria-current','page');
        }
      });
    })();
  </script>

  <main>
    <h2>Lista de Compras</h2>

    <div class="toolbar">
      <button class="btn btn--ghost" id="btn-clear-done">Limpar comprados</button>
      <button class="btn btn--ghost" id="btn-print">Exportar (PDF)</button>
      <button class="btn btn--danger" id="btn-reset">Apagar tudo</button>
    </div>

    <ul id="lista" class="lista"></ul>

    <button class="btn btn--brand" id="btn-partilhar">Partilhar Lista via WhatsApp</button>
  </main>

  <script type="module">
    import { auth, getShoppingList, setShoppingList } from './firebase.js';
    import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";

    const log = (...a)=>{ console.log('[ListaCompras]', ...a); };

    // HUD opcional
    if (typeof window.setHUD === 'undefined') window.setHUD = () => {};

    const LS_LISTA = 'mealmaster_listaCompras';
    let UID = null;
    let itens = [];     // [{nome, quantidade, comprado, src?, key?}]
    let dataReady = false;
    const ul = document.getElementById('lista');

    // ==== LocalStorage helpers ====
    function readFromLocalStorage(){
      try{
        const raw = JSON.parse(localStorage.getItem(LS_LISTA)) || {};
        // suporta { "__flat__":[...] } ou {categoria:[...]} antigo
        const arr = Array.isArray(raw.__flat__) ? raw.__flat__ : Object.values(raw).flat();
        return arr.map(i => ({
          nome: i?.nome || '',
          quantidade: i?.quantidade || '',
          comprado: !!i?.comprado,
          src: i?.src ?? null,
          key: i?.key ?? null
        }));
      }catch{ return []; }
    }
    function writeToLocalStorage(list){
      try{
        if (!list || !list.length) localStorage.removeItem(LS_LISTA);
        else localStorage.setItem(LS_LISTA, JSON.stringify({ "__flat__": list }));
      }catch{}
    }

    // ==== Load ====
    async function loadList(){
      log('loadList()â€¦');
      let arr;
      try{
        const r = await getShoppingList(UID);
        arr = Array.isArray(r) ? r : (Array.isArray(r?.items) ? r.items : undefined);
        log('Firestore â†’', arr);
      }catch(e){
        console.warn('Falha a ler do Firestore:', e);
      }

      // âš ï¸ Apenas faz fallback se NÃƒO recebemos um array (erro/offline).
      if(!Array.isArray(arr)){
        const ls = readFromLocalStorage();
        if(ls.length){
          log('Fallback localStorage =>', ls);
          arr = ls;
          // tenta sincronizar para Firestore
          try{ await setShoppingList(UID, arr); }catch(e){ console.warn('Sync fallback falhou:', e); }
        }else{
          arr = [];
        }
      }

      itens = arr.map(i => ({
        nome: i?.nome || '',
        quantidade: i?.quantidade || '',
        comprado: !!i?.comprado,
        src: i?.src ?? null,
        key: i?.key ?? null
      }));

      window.setHUD({uid:UID, n:itens.length, ready:dataReady, last:'load'});
    }

    // ==== Save ====
    async function saveList(){
      log('saveList()â€¦ itens=', itens);
      try{
        await setShoppingList(UID, itens);
        writeToLocalStorage(itens);   // â† manter LS em linha
        window.setHUD({uid:UID, n:itens.length, ready:dataReady, last:'save ok'});
        return true;
      }catch(err){
        console.error('Falha ao gravar lista:', err);
        window.setHUD({uid:UID, n:itens.length, ready:dataReady, last:'save ERROR'});
        return false;
      }
    }

    // ==== Render ====
    function render(){
      ul.innerHTML = '';
      if(!itens.length){
        const li = document.createElement('li');
        li.className = 'empty';
        li.textContent = 'A lista estÃ¡ vazia. Gera itens a partir do Plano Semanal ou envia a partir de uma receita.';
        ul.appendChild(li);
        return;
      }
      itens.forEach((item, idx) => {
        const li = document.createElement('li');
        if(item.comprado) li.classList.add('comprado');

        const chkWrap = document.createElement('label');
        chkWrap.className = 'checkbox-container';
        const chk = document.createElement('input');
        chk.type = 'checkbox';
        chk.checked = !!item.comprado;
        chk.addEventListener('change', async ()=>{
          item.comprado = chk.checked;
          li.classList.toggle('comprado', item.comprado);
          const ok = await saveList();
          if(!ok) alert('NÃ£o consegui gravar a alteraÃ§Ã£o.');
        });
        const custom = document.createElement('span'); custom.className = 'custom-checkbox';
        chkWrap.appendChild(chk); chkWrap.appendChild(custom);
        li.appendChild(chkWrap);

        const nome = document.createElement('span');
        nome.className = 'nome'; nome.textContent = item.nome || '';
        li.appendChild(nome);

        const qtd = document.createElement('input');
        qtd.type = 'text'; qtd.className = 'qtd';
        qtd.value = item.quantidade || '';
        qtd.placeholder = 'qtd.';
        qtd.addEventListener('input', async ()=>{
          item.quantidade = qtd.value;
          const ok = await saveList();
          if(!ok) alert('NÃ£o consegui gravar a alteraÃ§Ã£o.');
        });
        li.appendChild(qtd);

        const del = document.createElement('button');
        del.className = 'btn-eliminar'; del.textContent = 'Eliminar';
        del.addEventListener('click', async ()=>{
          if(confirm(`Eliminar "${item.nome}"?`)){
            const prev = itens.slice();
            itens.splice(idx,1);
            render();
            const ok = await saveList();
            if(!ok){ alert('NÃ£o consegui gravar no servidor. Vou repor a lista.'); itens = prev; render(); }
          }
        });
        li.appendChild(del);

        ul.appendChild(li);
      });
    }

    // === BotÃµes utilitÃ¡rios ===
    document.getElementById('btn-clear-done').addEventListener('click', async ()=>{
      if(!dataReady) return;
      const prev = itens.slice();
      itens = itens.filter(i => !i.comprado);
      render();
      const ok = await saveList();
      if(!ok){ alert('Falhou guardar. A repor.'); itens = prev; render(); }
    });
    document.getElementById('btn-print').addEventListener('click', ()=>window.print());
    document.getElementById('btn-reset').addEventListener('click', async ()=>{
      if(!dataReady) return;
      if(confirm('Apagar toda a lista de compras?')){
        const prev = itens.slice();
        itens = [];
        writeToLocalStorage(itens);   // â† limpar LS de imediato
        render();
        const ok = await saveList();
        if(!ok){ alert('Falhou guardar. A repor.'); itens = prev; render(); }
      }
    });

    document.getElementById('btn-partilhar').addEventListener('click', ()=>{
      let texto = 'ðŸ›’ Minha Lista de Compras:%0A%0A';
      itens.forEach(i=>{ texto += `- ${i.nome}${i.quantidade ? ' ('+i.quantidade+')' : ''}%0A`; });
      window.open(`https://wa.me/?text=${texto}`,'_blank');
    });

    onAuthStateChanged(auth, async (u)=>{
      log('onAuthStateChanged', u?.uid);
      if(!u){ location.href='index.html'; return; }
      UID = u.uid;
      await loadList();
      dataReady = true;
      render();
    });
  </script>
</body>
</html>
